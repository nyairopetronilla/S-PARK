{% extends "layout.html" %}
{% block title %}Registered Vehicles{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto mt-10">
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-3xl font-bold">ðŸš˜ Vehicle List</h2>
    
    {% if session.get('role') in ['admin', 'security', 'security1', 'security2'] %}
    <a href="/register-vehicle" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded shadow">
      âž• Register New Vehicle
    </a>
    {% endif %}
  </div>

  <!-- ðŸ”½ Export PDF Button -->
  <div class="mb-4">
    <button onclick="exportPDF()" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded shadow">
      ðŸ“„ Export to PDF
    </button>
  </div>

  <div class="overflow-x-auto">
    <table id="vehicleTable" class="min-w-full bg-gray-800 text-white text-sm rounded-xl overflow-hidden">
      <thead class="bg-gray-700 text-xs uppercase">
        <tr>
          <th class="p-3">Plate</th>
          <th class="p-3">Owner</th>
          <th class="p-3">Phone</th>
          <th class="p-3">Brand</th>
          <th class="p-3">Model</th>
          <th class="p-3">Color</th>
          {% if session.get('role') == 'admin' %}
          <th class="p-3">Actions</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for v in vehicles %}
        <tr class="border-t border-gray-700">
          <td class="p-3">{{ v.registration_plate }}</td>
          <td class="p-3">{{ v.owner_name }}</td>
          <td class="p-3">{{ v.phone_number }}</td>
          <td class="p-3">{{ v.brand }}</td>
          <td class="p-3">{{ v.model }}</td>
          <td class="p-3">{{ v.color }}</td>
          {% if session.get('role') == 'admin' %}
          <td class="p-3 space-x-2">
            <a href="/admin/edit-vehicle/{{ v.vehicle_id }}" class="text-blue-400 hover:underline">Edit</a>
            <a href="/admin/delete-vehicle/{{ v.vehicle_id }}" class="text-red-400 hover:underline">Delete</a>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <span id="pdf-generator" data-user="{{ session['username'] }}"></span>
  </div>
</div>

<!-- DataTables + PDF Export -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<!-- PDF Export Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
  $(document).ready(function () {
    $('#vehicleTable').DataTable({
      order: [[0, 'desc']]
    });
  });
</script>

<script>
  function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const username = document.getElementById("pdf-generator").dataset.user || "Unknown";
    const now = new Date().toLocaleString();

    doc.setFontSize(12);
    doc.text(`Vehicle List - Smart Parking`, 14, 15);
    doc.setFontSize(10);
    doc.text(`Generated by: ${username}`, 14, 22);
    doc.text(`Generated on: ${now}`, 14, 28);

    doc.autoTable({
      html: '#vehicleTable',
      startY: 35,
      theme: 'grid',
      styles: { fontSize: 9 }
    });

    doc.save(`vehicle_list_${now.replace(/[\s:/]/g, '_')}.pdf`);
  }
</script>

{% endblock %}
